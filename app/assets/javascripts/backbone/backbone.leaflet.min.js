/*! backbone.leaflet - v0.0.1-dev - 3/30/2013
* http://github.com/LuizArmesto/backbone.leaflet
* Copyright (c) 2013 Luiz Armesto; Licensed MIT */
(function(e,t,n){"use strict";var r=e.$,i={};i.VERSION="0.0.1-dev";var s=e.Leaflet;e.Leaflet=i,i.noConflict=function(){return e.Leaflet=s,this};var o=i.GeoModel=e.Model.extend({set:function(n,r,i){var s,o,u,a;return s=arguments,typeof n=="object"&&(o=n,i=r),o&&o.type&&o.type==="Feature"&&(u=t.clone(o.properties)||{},a=t.clone(o.geometry)||null,a&&(a.coordinates=a.coordinates.slice()),u.geometry=a,s=[u,i]),e.Model.prototype.set.apply(this,s)},toJSON:function(e){var n,r,i;return e=e||{},n=t.clone(this.attributes),r=t.omit(n,"geometry"),e.cid&&(r.cid=this.cid),i=t.clone(n.geometry)||null,i&&(i.coordinates=i.coordinates.slice()),{type:"Feature",geometry:i,properties:r}}}),u=i.GeoCollection=e.Collection.extend({model:o,reset:function(n,r){return n&&!t.isArray(n)&&n.features&&(n=n.features),e.Collection.prototype.reset.apply(this,[n,r])},toJSON:function(t){var n=e.Collection.prototype.toJSON.apply(this,arguments);return{type:"FeatureCollection",features:n}}}),a=function(e,t){var r=this._getModelByFeature(e);return new n.Marker(t,this.modelStyle(r))},f=function(e,t){var n=this._getModelByFeature(e);return this.modelFilter(n)},l=function(e){var t=this._getModelByFeature(e);return this.modelStyle(t)},c=function(e,n){this._layers[e.properties.cid]=n,n.cid=e.properties.cid;var r=["click","mouseover"],i=this;t.each(r,function(e){n.on(e,function(t){var r=n._map;r.fire.apply(r,["layer_"+e].concat(arguments))})})},h=/^(\S+)\s*(.*)$/,p=i.MapView=function(t){e.View.apply(this,arguments),this._layers={},this._layer=this._getLayer(),this._layer.addTo(this.map);if(this.collection){if(!this.collection instanceof u)throw new Error('The "collection" option should be instance of "GeoCollection" to be used within Map view');this._ensureMap(),this.listenTo(this.collection,"reset",this._onReset),this.listenTo(this.collection,"add",this._onAdd),this.listenTo(this.collection,"remove",this._onRemove),this.listenTo(this.collection,"change",this._onChange),this.redraw()}};p.extend=e.View.extend,t.extend(p.prototype,e.View.prototype,{defaultLayerOptions:{pointToLayer:a,filter:f,style:l,onEachFeature:c},defaultStyle:{},defaultMapOptions:{center:[-23.5,-46.6167],zoom:14},redraw:function(){return this._layers={},this._layer.clearLayers(),this._layer.addData(this.collection.toJSON({cid:!0})),this},delegateEvents:function(n){this._ensureMap();var r="delegateEvents"+this.cid;e.View.prototype.delegateEvents.apply(this,arguments);if(!n&&!(n=t.result(this,"events")))return this;var i=function(e){return function(t){var n=t[0];e(n)}};this._leaflet_events={};for(var s in n){var o=n[s];t.isFunction(o)||(o=this[n[s]]);if(!o)throw new Error('Method "'+n[s]+'" does not exist');var u=s.match(h),a=u[1],f=u[2];o=t.bind(o,this);if(f==="map"||f==="layer")f==="layer"&&(a="layer_"+a,o=i(o)),this.map.on(a,o,r),this._leaflet_events[a]=o}return this},undelegateEvents:function(){var t="delegateEvents"+this.cid;return this.map.off(this._leaflet_events||{},t),this._leaflet_events=null,e.View.prototype.undelegateEvents.apply(this,arguments)},getTileLayer:function(){return new n.TileLayer("http:///{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png",{attribution:'Data, imagery and map information provided by <a href="http://www.mapquest.com/">MapQuest</a>, <a href="http://www.openstreetmap.org/">Open Street Map</a> and contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>.',subdomains:["otile1","otile2","otile3","otile4"]})},_ensureMap:function(){this.map||(this.mapOptions=t.defaults(this.options.map||{},this.defaultMapOptions),this.map=new n.Map(this.el,this.mapOptions),this.tileLayer=this.getTileLayer(),this.tileLayer.addTo(this.map))},modelFilter:function(e){return e?this.options.filter&&t.isFunction(this.options.filter)?this.options.filter.apply(this,arguments):!this._layers[e.cid]:!0},modelStyle:function(e){return e?this.options.style?t.isFunction(this.options.style)?this.options.style.apply(this,arguments):this.options.style:e.getStyle&&t.isFunction(e.getStyle)?e.getStyle():this.defaultStyle:this.defaultStyle},_getModelByFeature:function(e){var n=t.where(this.collection.models,{cid:e.properties.cid});return n[0]},_getLayer:function(){var e,r;return r=t.defaults(this.options.layer||{},this.defaultLayerOptions),e=["pointToLayer","filter","style","onEachFeature"],t.each(e,function(e){r[e]=t.bind(r[e],this)},this),new n.GeoJSON(null,r)},_onReset:function(){this.redraw()},_onAdd:function(e){this._layer.addData(e.toJSON({cid:!0}))},_onRemove:function(e){var t=this._layers[e.cid];t&&(this._layer.removeLayer(t),this._layers[e.cid]=null)},_onChange:function(e){var n,r=this._layers[e.cid];e.hasChanged("geometry")?(this._onRemove(e),this._onAdd(e)):(n=this.modelStyle(e),r.setStyle&&t.isFunction(r.setStyle)?r.setStyle(n):r.setIcon&&t.isFunction(r.setIcon)&&r.setOpacity&&t.isFunction(r.setOpacity)&&(n.icon&&r.setIcon(n.icon),n.opacity&&r.setOpacity(n.opacity)))}});var d=i.SatelliteView=p.extend({defaultMapOptions:{center:[-23.5,-46.6167],zoom:11},getTileLayer:function(){return new n.TileLayer("http:///{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.jpg",{attribution:'Data and imagery provided by <a href="http://www.mapquest.com/">MapQuest</a>. Portions Courtesy NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency.',subdomains:["otile1","otile2","otile3","otile4"]})}})})(Backbone,_,L);